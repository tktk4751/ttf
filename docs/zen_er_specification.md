# ZEN_ER（超高精度効率比）インジケーター仕様書

## 概要

ZEN_ERは、既存のEfficiency Ratio（効率比）を大幅に改良した、超高精度・超低遅延・超追従性・超動的適応性・超ノイズ除去性を実現する最先端の効率比インジケーターです。

### 設計思想

- **適応・追従性重視**: 予測よりも実際の市場動向への適応と追従を重視
- **シンプルさ**: 複雑さよりもシンプルで洗練されたアルゴリズムを採用
- **リアルタイム性**: 超低遅延でのリアルタイム計算を実現

## 主要機能

### 1. 多層アダプティブフィルタリング

#### レイヤー1: 自前実装ヒルベルト変換による瞬時位相解析
- **目的**: 価格変動の瞬時的な位相情報を抽出
- **手法**: NumPy FFTベースの独自ヒルベルト変換実装
- **出力**: 瞬時振幅、瞬時周波数、瞬時位相
- **特徴**: SciPy不要の軽量実装

#### レイヤー2: カルマンフィルター適応システム
- **目的**: ノイズ除去と状態推定
- **手法**: 適応カルマンフィルター（ノイズ分散を動的調整）
- **特徴**: 
  - 状態ベクトル: [価格, 速度, 加速度]
  - 観測ノイズの動的調整
  - プロセスノイズの市場ボラティリティ連動

#### レイヤー3: 自前実装ウェーブレット分解による多重解像度解析
- **目的**: 異なる時間スケールでの効率性分析
- **手法**: Haarウェーブレット近似による独自DWT実装
- **ウェーブレット**: 簡易Haar（計算効率重視）
- **分解レベル**: 3レベル（短期・中期・長期）
- **特徴**: PyWavelets不要の軽量実装

### 2. 動的期間適応システム

#### ドミナントサイクル検出
- **基本手法**: Modified Ehlers Instantaneous Trend
- **改良点**: ヒルベルト変換による位相情報統合
- **出力**: リアルタイム最適期間

#### 適応効率比計算
- **従来手法**: 固定期間での価格変化/ボラティリティ
- **ZEN_ER手法**: 
  1. 多重時間枠での効率比計算
  2. ウェーブレット係数による重み付け
  3. カルマンフィルターによる平滑化

### 3. 超低遅延リアルタイム計算

#### 増分計算システム
- **手法**: 過去の計算結果を活用した増分更新
- **メモリ効率**: ローリングウィンドウによる定メモリ使用
- **計算効率**: O(1)の時間計算複雑度

#### パイプライン処理
- **並列化**: Numba JITコンパイルによる高速化
- **ベクトル化**: NumPy配列操作の最適化

### 4. ノイズ耐性システム

#### アダプティブしきい値
- **統計的手法**: ローリング標準偏差による動的しきい値
- **ロバスト統計**: 外れ値に対する耐性
- **信頼区間**: 95%信頼区間による異常値検出

#### スパイクフィルター
- **手法**: メディアンフィルターとの併用
- **目的**: 急激な価格変動（スパイク）の除去

## 技術仕様

### 入力パラメータ

#### 基本パラメータ
- `src_type`: 価格ソース（'hlc3', 'close', 'ohlc4'等）
- `base_period`: 基本計算期間（デフォルト: 14）
- `adaptive_factor`: 適応係数（デフォルト: 0.618）

#### フィルタリングパラメータ
- `kalman_noise_ratio`: カルマンフィルターノイズ比（デフォルト: 0.1）
- `wavelet_threshold`: ウェーブレットしきい値（デフォルト: 0.05）
- `hilbert_window`: ヒルベルト変換ウィンドウサイズ（デフォルト: 21）

#### 適応パラメータ
- `adaptation_speed`: 適応速度（デフォルト: 0.5）
- `min_period`: 最小計算期間（デフォルト: 5）
- `max_period`: 最大計算期間（デフォルト: 50）

### 出力データ

#### 主要出力
- `zen_er`: ZEN効率比値（0-1の範囲）
- `trend_strength`: トレンド強度（-1〜1の範囲）
- `cycle_phase`: サイクル位相（0-2πの範囲）
- `noise_level`: ノイズレベル（0-1の範囲）

#### 補助出力
- `instantaneous_period`: 瞬時期間
- `hilbert_amplitude`: ヒルベルト振幅
- `wavelet_energy`: ウェーブレットエネルギー
- `kalman_velocity`: カルマン速度

### アルゴリズム詳細

#### Step 1: 前処理
1. 価格データの取得とバリデーション
2. 欠損値の補間（線形補間）
3. 外れ値の検出と処理

#### Step 2: ヒルベルト変換解析
1. 解析信号の生成
2. 瞬時振幅・位相・周波数の計算
3. ドミナントサイクルの推定

#### Step 3: カルマンフィルタリング
1. 状態推定（価格、速度、加速度）
2. ノイズ分散の動的調整
3. 平滑化された価格系列の生成

#### Step 4: ウェーブレット分解
1. 3レベルDWT実行
2. 各レベルでの効率比計算
3. エネルギー重み付け統合

#### Step 5: 適応効率比計算
1. 多重時間枠での効率比計算
2. 動的期間による調整
3. 最終ZEN_ER値の生成

#### Step 6: 品質指標計算
1. トレンド強度の評価
2. ノイズレベルの測定
3. 信頼度スコアの算出

## パフォーマンス目標

### 精度指標
- **追従性**: 従来比150%向上
- **ノイズ除去**: SNR比200%向上
- **遅延**: 従来比70%削減

### 計算効率
- **リアルタイム処理**: 1000データポイント/秒以上
- **メモリ使用量**: 固定サイズバッファ使用
- **CPU使用率**: シングルコア10%以下

## 使用方法

### 基本的な使用例
```python
zen_er = ZenEfficiencyRatio(
    base_period=14,
    src_type='hlc3',
    adaptive_factor=0.618
)

result = zen_er.calculate(price_data)
zen_values = result.zen_er
trend_strength = result.trend_strength
```

### 高度な使用例
```python
zen_er = ZenEfficiencyRatio(
    base_period=21,
    kalman_noise_ratio=0.05,
    wavelet_threshold=0.03,
    adaptation_speed=0.7
)

result = zen_er.calculate(price_data)
```

## 解釈ガイド

### ZEN_ER値の解釈
- **0.8 - 1.0**: 非常に効率的（強いトレンド）
- **0.6 - 0.8**: 効率的（中程度のトレンド）
- **0.4 - 0.6**: 中立（レンジ相場）
- **0.2 - 0.4**: 非効率的（弱いトレンド）
- **0.0 - 0.2**: 非常に非効率的（強いノイズ）

### トレンド強度の解釈
- **0.7 - 1.0**: 強い上昇トレンド
- **0.3 - 0.7**: 弱い上昇トレンド
- **-0.3 - 0.3**: レンジ相場
- **-0.7 - -0.3**: 弱い下降トレンド
- **-1.0 - -0.7**: 強い下降トレンド

## 実装ノート

### 依存ライブラリ
- NumPy: 数値計算とFFTベースの信号処理
- Numba: JITコンパイルによる超高速化

**注意**: SciPyやPyWaveletsへの依存は一切ありません。純粋なNumPy/Numba実装により、軽量で高速な動作を実現しています。

### 最適化ポイント
1. **Numba JIT**: 計算集約的な部分の高速化
2. **ベクトル化**: ループ処理の削減
3. **メモリプール**: 動的メモリ確保の削減
4. **キャッシュ効率**: データ局所性の向上

### 拡張性
- 新しいウェーブレット基底の追加
- カスタムカルマンフィルターモデル
- 他のインジケーターとの連携

## テスト計画

### 単体テスト
- 各コンポーネントの独立テスト
- エッジケースの処理確認
- パフォーマンステスト

### 統合テスト
- 実際の市場データでの検証
- 既存ERとの比較
- ロバスト性テスト

### ベンチマーク
- 精度指標の測定
- 計算速度の測定
- メモリ使用量の測定 