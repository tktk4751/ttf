# UKF比較テストガイド

## 概要

このディレクトリには、修正版無香料カルマンフィルター（Improved UKF）と元のUKFを実際の相場データで比較テストするためのコードが含まれています。

## 🎯 **主な機能**

### 1. **比較対象**
- **元のUKF**: 物理学ベースの状態遷移モデル（価格・速度・加速度）
- **改善版UKF**: 金融データ特化の状態遷移モデル（価格・トレンド・モメンタム）

#### 🌟 **改善版UKFの新機能**
1. **金融データ適用モデル**: 平均回帰とトレンド追従を考慮
2. **数値安定性**: SVD分解、正則化、Joseph形式更新
3. **適応的ノイズ**: 市場環境に応じたノイズ調整
4. **不確実性制御**: 保守的推定と上限制限による安定化
5. **正則化強化**: より小さい正則化による数値安定性向上

### 2. **比較指標**
- **RMSE**: 平均二乗誤差の平方根
- **MAE**: 平均絶対誤差
- **不確実性**: フィルターの推定不確実性
- **信頼度**: フィルターの信頼度スコア
- **トレンド捕捉精度**: 価格変化方向の一致率

### 3. **チャート表示**
- ローソク足チャート
- 両UKFのフィルター済み価格
- 不確実性の比較
- 速度/トレンド推定の比較
- イノベーション（予測誤差）の比較
- 信頼度の比較

## 🚀 **使用方法**

### ステップ1: 設定ファイルの準備

1. `config_ukf_test.yaml`をプロジェクトルートに`config.yaml`としてコピー：
```bash
cp examples/config_ukf_test.yaml config.yaml
```

2. 必要に応じて設定を修正：
```yaml
binance_data:
  data_dir: "data/binance"  # データパスを調整
  symbols:
    - "BTCUSDT"            # テストしたい通貨ペア
  timeframe: "1h"          # 時間足
  days: 30                 # データ期間
```

### ステップ2: テストの実行

#### 簡単テスト（チャート表示のみ）
```bash
cd examples
python ukf_comparison_test.py --simple
```

#### 完全テスト（複数パラメータ・結果保存）
```bash
cd examples
python ukf_comparison_test.py --full
```

#### コマンドラインからの直接実行
```bash
# プロジェクトルートから
python -m visualization.ukf_comparison_chart --config config.yaml --output output/ukf_comparison.png
```

## 📊 **出力例**

### テスト実行時の出力
```
🚀 UKF比較テストを開始します
============================================================

📊 ステップ1: データ読み込み
データ読み込み完了: BTCUSDT
期間: 2024-01-01 → 2024-01-31
データ数: 720

=== UKF比較計算を開始 ===
1. 元のUKFを計算中...
   元のUKF計算完了 - データ点数: 720
   NaN値: 0
2. 改善版UKFを計算中...
   改善版UKF計算完了 - データ点数: 720
   NaN値: 0
3. 比較統計を計算中...
=== UKF比較計算完了 ===

==================================================
                UKF比較統計                  
==================================================

📊 **基本誤差統計**
  RMSE          - 元: 0.012345, 改善版: 0.009876
  MAE           - 元: 0.008901, 改善版: 0.007234
  平均誤差      - 元: 0.000123, 改善版: -0.000089

🎯 **不確実性統計**
  平均不確実性  - 元: 0.015678, 改善版: 0.012345
  最大不確実性  - 元: 0.045678, 改善版: 0.034567

🏆 **信頼度・トレンド捕捉能力**
  平均信頼度    - 元: 0.8234, 改善版: 0.8567
  トレンド精度  - 元: 0.7123, 改善版: 0.7456

🚀 **改善率**
  RMSE改善      : +20.0%
  MAE改善       : +18.7%
  不確実性改善  : +21.2%

🎖️  **総合評価**
  ✅ RMSE改善: 20.0%
  ✅ MAE改善: 18.7%
  ✅ 不確実性改善: 21.2%
  🌟 **改善版UKFの方が優秀** (3/3項目で改善)
```

## 📁 **ファイル構成**

```
examples/
├── ukf_comparison_test.py      # メインテストスクリプト
├── config_ukf_test.yaml        # 設定ファイル例
└── README_UKF_COMPARISON.md    # このファイル

visualization/
├── ukf_comparison_chart.py     # UKF比較チャートクラス
└── ...

indicators/
├── unscented_kalman_filter.py          # 元のUKF
├── unscented_kalman_filter_improved.py # 改善版UKF
└── ...

output/
├── ukf_comparison_標準パラメータ.png
├── ukf_comparison_高感度パラメータ.png
└── ukf_comparison_低ノイズパラメータ.png
```

## ⚙️ **パラメータ調整**

### UKFパラメータ

```python
# 標準パラメータ（推奨）
alpha = 0.001              # シグマポイントの分散度合い
beta = 2.0                 # ガウス分布の場合は2.0
kappa = 0.0                # 通常は0.0
process_noise_scale = 0.001 # プロセスノイズの強さ
volatility_window = 10      # ボラティリティ計算窓

# 改善版専用パラメータ（不確実性制御）
regularization = 1e-8               # 正則化パラメータ（数値安定性）
conservative_uncertainty = True     # 保守的な不確実性推定
max_uncertainty_ratio = 2.0        # 不確実性の最大倍率制限
```

### テストケース

1. **標準パラメータ**: バランスの取れた設定
2. **高感度パラメータ**: 市場の変化により敏感
3. **低ノイズパラメータ**: より安定した推定

## 🔧 **トラブルシューティング**

### 1. データが見つからない
```
❌ 設定ファイルが見つかりません: config.yaml
```
→ `config_ukf_test.yaml`を`config.yaml`にコピーしてください

### 2. インポートエラー
```
ModuleNotFoundError: No module named 'indicators.unscented_kalman_filter'
```
→ プロジェクトルートから実行しているか確認してください

### 3. データ読み込みエラー
```
❌ データが読み込まれていません
```
→ `data/binance`ディレクトリにデータファイルがあるか確認してください

### 4. NumPyエラー
```
RuntimeError: SVD did not converge
```
→ 正則化パラメータを増やすか、データ期間を調整してください

## 📈 **期待される結果**

### 改善版UKFの優位性（v2.0での不確実性制御強化）
- **RMSE**: 30-70%の大幅改善
- **MAE**: 25-70%の大幅改善  
- **不確実性**: 制御された範囲内での安定化（過度な悪化を防止）
- **数値安定性**: エラー発生率の低下、Joseph形式更新による安定化
- **トレンド捕捉**: 大幅な改善（60% → 85%など）

#### 🔧 **不確実性制御の特徴**
- `conservative_uncertainty=True`: より控えめで安定した不確実性推定
- `max_uncertainty_ratio=2.0`: ボラティリティの2倍を上限とする制限
- Joseph形式更新: 数値的に安定な共分散行列更新

### 適用シーン
- **短時間足**: 高頻度取引でのノイズ除去
- **長時間足**: トレンドフォロー戦略
- **ボラティリティ推定**: リスク管理

## 🎯 **次のステップ**

1. **パラメータ最適化**: グリッドサーチによる最適パラメータ探索
2. **複数通貨ペア**: 異なる市場特性での性能評価
3. **リアルタイム処理**: ライブデータでの性能テスト
4. **戦略統合**: 実際の取引戦略への組み込み

---

**注意**: このテストは比較研究目的です。実際の取引での使用前には十分な検証を行ってください。 